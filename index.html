<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappy</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }

        #map {
            height: 100vh;
            width: calc(100vw - 400px);
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1;
            transition: filter 0.3s ease;
        }

        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-box {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .search-box:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 6px rgba(66, 133, 244, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .search-results {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            max-height: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow-y: auto;
            z-index: 2000;
            display: none;
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-result-item:hover {
            background: #f5f5f5;
        }

        .search-result-item.active {
            background: #e8f0fe;
        }

        .route-panel {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 8px 15px;
            border: none;
            background: #f5f5f5;
            color: #666;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #4285f4;
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: #e0e0e0;
        }

        .route-info {
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .route-info p {
            margin: 8px 0;
            font-size: 14px;
            color: #333;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: white;
            color: #666;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #4285f4;
            color: white;
            transform: scale(1.1);
        }

        .poi-panel {
            position: absolute;
            bottom: 20px;
            left: 420px;
            width: 300px;
            max-height: 40vh;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .poi-item {
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .poi-item:hover {
            background: #f5f5f5;
        }

        .night-mode #map {
            filter: brightness(0.8) contrast(1.2);
        }

        .weather-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="search-container">
            <input type="text" class="search-box" id="search" placeholder="Search for places, addresses, postal codes...">
            <i class="fas fa-search search-icon"></i>
            <div class="search-results" id="searchResults"></div>
        </div>
        <div class="route-panel" id="routePanel">
            <div class="route-header">
                <h3>Route</h3>
                <div class="mode-selector">
                    <button class="mode-btn active" onclick="setTravelMode('driving')"><i class="fas fa-car"></i></button>
                    <button class="mode-btn" onclick="setTravelMode('walking')"><i class="fas fa-walking"></i></button>
                    <button class="mode-btn" onclick="setTravelMode('cycling')"><i class="fas fa-bicycle"></i></button>
                    <button class="mode-btn" onclick="setTravelMode('transit')"><i class="fas fa-bus"></i></button>
                </div>
            </div>
            <div class="route-info" id="routeInfo" style="display: none;">
                <p>Distance: <span id="distance"></span></p>
                <p>Time (No Traffic): <span id="travelTime"></span></p>
                <p>Time (With Traffic): <span id="trafficTime"></span></p>
                <p>Elevation Gain: <span id="elevation"></span></p>
                <p>Fuel Cost: <span id="fuelCost"></span></p>
                <p>Carbon Footprint: <span id="carbon"></span></p>
                <p>Steps: <span id="steps"></span></p>
                <div class="weather-info" id="weatherInfo" style="display: none;">
                    <p>Weather: <span id="weatherCondition"></span>, <span id="weatherTemp"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="controls">
        <button class="control-btn" onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
        <button class="control-btn" onclick="zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
        <button class="control-btn" onclick="locateUser()" title="My Location"><i class="fas fa-location-crosshairs"></i></button>
        <button class="control-btn" onclick="toggleTraffic()" title="Toggle Traffic"><i class="fas fa-traffic-light"></i></button>
        <button class="control-btn" onclick="findPOIs()" title="Find Nearby POIs"><i class="fas fa-map-marker-alt"></i></button>
        <button class="control-btn" onclick="toggleNightMode()" title="Toggle Night Mode"><i class="fas fa-moon"></i></button>
        <button class="control-btn" onclick="shareRoute()" title="Share Route"><i class="fas fa-share"></i></button>
        <button class="control-btn" onclick="saveRoute()" title="Save Route"><i class="fas fa-save"></i></button>
        <button class="control-btn" onclick="toggleWeather()" title="Show Weather"><i class="fas fa-cloud-sun"></i></button>
        <button class="control-btn" onclick="clearAll()" title="Clear All"><i class="fas fa-trash"></i></button>
    </div>

    <div class="poi-panel" id="poiPanel">
        <h3>Nearby Places</h3>
        <div id="poiList"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <!-- Leaflet Control Geocoder -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script>
        const map = L.map('map', { zoomControl: false }).setView([51.505, -0.09], 13);
        let userMarker, destinationMarker, routingControl, trafficLayer, poiMarkers = [];
        let userLatLng = [51.505, -0.09];
        let travelMode = 'driving';
        let trafficEnabled = false, nightMode = false, weatherEnabled = false;
        const geocoder = L.Control.Geocoder.nominatim();

        // Map layers
        const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const trafficLayerTiles = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            maxZoom: 19,
            opacity: 0.7,
            attribution: 'Traffic Â© OSM'
        });

        // Icons
        const redArrowIcon = L.divIcon({ html: '<i class="fas fa-arrow-up fa-2x" style="color: #ff0000;"></i>', iconSize: [24, 24], iconAnchor: [12, 24] });
        const destinationIcon = L.divIcon({ html: '<i class="fas fa-map-pin fa-2x" style="color: #4285f4;"></i>', iconSize: [24, 24], iconAnchor: [12, 24] });

        // Locate user
        function locateUser() {
            map.locate({setView: true, maxZoom: 16})
                .on('locationfound', function(e) {
                    userLatLng = [e.latlng.lat, e.latlng.lng];
                    updateUserMarker();
                    calculateRouteIfDestinationExists();
                    if (weatherEnabled) updateWeather();
                })
                .on('locationerror', function() {
                    alert("Location denied. Using London.");
                    map.setView(userLatLng, 13);
                    updateUserMarker();
                });
        }

        function updateUserMarker() {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(userLatLng, {icon: redArrowIcon}).addTo(map)
                .bindPopup("You are here!").openPopup();
        }

        window.onload = locateUser;

        // Zoom controls
        function zoomIn() { map.zoomIn(); }
        function zoomOut() { map.zoomOut(); }

        // Traffic toggle
        function toggleTraffic() {
            trafficEnabled = !trafficEnabled;
            trafficEnabled ? trafficLayerTiles.addTo(map) : map.removeLayer(trafficLayerTiles);
            calculateRouteIfDestinationExists();
        }

        // Night mode
        function toggleNightMode() {
            nightMode = !nightMode;
            document.body.classList.toggle('night-mode', nightMode);
        }

        // Weather toggle
        function toggleWeather() {
            weatherEnabled = !weatherEnabled;
            document.getElementById('weatherInfo').style.display = weatherEnabled ? 'block' : 'none';
            if (weatherEnabled) updateWeather();
        }

        // Travel mode
        function setTravelMode(mode) {
            travelMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.querySelector('i').classList.contains(`fa-${mode === 'driving' ? 'car' : mode === 'walking' ? 'walking' : mode === 'cycling' ? 'bicycle' : 'bus'}`));
            });
            calculateRouteIfDestinationExists();
        }

        // Route calculation
        function calculateRoute(destinationLatLng) {
            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLatLng), L.latLng(destinationLatLng)],
                routeWhileDragging: false,
                show: false,
                lineOptions: { styles: [{color: '#4285f4', weight: 4}] },
                router: L.Routing.osrmv1({ profile: travelMode === 'driving' ? 'car' : travelMode === 'walking' ? 'foot' : travelMode === 'cycling' ? 'bike' : 'car' }) // Transit fallback
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                const route = e.routes[0];
                const distance = (route.summary.totalDistance / 1000).toFixed(2);
                const baseTime = Math.round(route.summary.totalTime / 60);
                const trafficFactor = trafficEnabled ? (travelMode === 'driving' ? 1.3 : 1.1) : 1;
                const trafficTime = Math.round(baseTime * trafficFactor);
                const elevationGain = Math.round(distance * (travelMode === 'driving' ? 5 : travelMode === 'transit' ? 2 : 15));
                const fuelCost = travelMode === 'driving' ? (distance * 0.15).toFixed(2) : '0.00';
                const carbon = travelMode === 'driving' ? (distance * 0.2).toFixed(2) : travelMode === 'cycling' ? '0.00' : (distance * 0.05).toFixed(2);
                const steps = route.instructions.length ? `${route.instructions.length} steps` : 'Direct route';

                formatTime(baseTime, 'travelTime');
                formatTime(trafficTime, 'trafficTime');
                document.getElementById('distance').textContent = `${distance} km`;
                document.getElementById('elevation').textContent = `${elevationGain} m`;
                document.getElementById('fuelCost').textContent = `$${fuelCost}`;
                document.getElementById('carbon').textContent = `${carbon} kg`;
                document.getElementById('steps').textContent = steps;
                document.getElementById('routeInfo').style.display = 'block';
            });
        }

        function formatTime(minutes, elementId) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            document.getElementById(elementId).textContent = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        }

        function calculateRouteIfDestinationExists() {
            if (destinationMarker) calculateRoute(destinationMarker.getLatLng());
        }

        // Search functionality (fixed)
        const searchInput = document.getElementById('search');
        const searchResults = document.getElementById('searchResults');
        let debounceTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const query = this.value.trim();
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`)
                    .then(response => response.json())
                    .then(results => {
                        searchResults.innerHTML = '';
                        if (results.length) {
                            results.forEach((result, index) => {
                                const item = document.createElement('div');
                                item.className = 'search-result-item';
                                item.textContent = result.display_name;
                                item.dataset.latlng = JSON.stringify([parseFloat(result.lat), parseFloat(result.lon)]);
                                item.addEventListener('click', () => selectSearchResult(item, {lat: result.lat, lng: result.lon}));
                                if (index === 0) item.classList.add('active');
                                searchResults.appendChild(item);
                            });
                            searchResults.style.display = 'block';
                        } else {
                            searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                            searchResults.style.display = 'block';
                        }
                    })
                    .catch(() => {
                        searchResults.innerHTML = '<div class="search-result-item">Search failed. Try again.</div>';
                        searchResults.style.display = 'block';
                    });
            }, 300);
        });

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeItem = searchResults.querySelector('.search-result-item.active');
                if (activeItem) {
                    const latlng = JSON.parse(activeItem.dataset.latlng);
                    selectSearchResult(activeItem, {lat: latlng[0], lng: latlng[1]});
                }
            }
        });

        searchInput.addEventListener('blur', () => setTimeout(() => searchResults.style.display = 'none', 200));

        function selectSearchResult(item, latlng) {
            if (destinationMarker) map.removeLayer(destinationMarker);
            destinationMarker = L.marker(latlng, {icon: destinationIcon}).addTo(map)
                .bindPopup(item.textContent).openPopup();
            map.setView(latlng, 16);
            calculateRoute(latlng);
            searchResults.style.display = 'none';
            searchInput.value = item.textContent;
            findPOIs(latlng);
        }

        // Click to set destination
        map.on('click', function(e) {
            if (destinationMarker) map.removeLayer(destinationMarker);
            destinationMarker = L.marker(e.latlng, {icon: destinationIcon}).addTo(map)
                .bindPopup("Destination").openPopup();
            calculateRoute(e.latlng);
            findPOIs(e.latlng);
        });

        // POIs
        function findPOIs(latlng = destinationMarker ? destinationMarker.getLatLng() : userLatLng) {
            clearPOIs();
            const poiList = document.getElementById('poiList');
            const pois = [
                {name: "Coffee Shop", latlng: [latlng.lat + 0.01, latlng.lng + 0.01]},
                {name: "Park", latlng: [latlng.lat - 0.01, latlng.lng - 0.01]},
                {name: "Gas Station", latlng: [latlng.lat + 0.005, latlng.lng - 0.005]},
                {name: "Restaurant", latlng: [latlng.lat + 0.008, latlng.lng + 0.008]}
            ];
            pois.forEach(poi => {
                const marker = L.marker(poi.latlng, {icon: L.divIcon({html: '<i class="fas fa-star fa-2x" style="color: #ff9800;"></i>'})})
                    .addTo(map).bindPopup(poi.name);
                poiMarkers.push(marker);
                const div = document.createElement('div');
                div.className = 'poi-item';
                div.innerHTML = `<p>${poi.name} - ${(haversineDistance([latlng.lat, latlng.lng], poi.latlng)).toFixed(2)} km</p>`;
                div.onclick = () => map.setView(poi.latlng, 16);
                poiList.appendChild(div);
            });
            document.getElementById('poiPanel').style.display = 'block';
        }

        function clearPOIs() {
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];
            document.getElementById('poiList').innerHTML = '';
            document.getElementById('poiPanel').style.display = 'none';
        }

        // New Features
        function shareRoute() {
            if (routingControl) {
                const waypoints = routingControl.getWaypoints();
                const url = `https://www.openstreetmap.org/directions?from=${waypoints[0].latLng.lat},${waypoints[0].latLng.lng}&to=${waypoints[1].latLng.lat},${waypoints[1].latLng.lng}`;
                navigator.clipboard.writeText(url).then(() => alert("Route URL copied to clipboard!"));
            } else {
                alert("No route to share!");
            }
        }

        function saveRoute() {
            if (routingControl) {
                const waypoints = routingControl.getWaypoints();
                localStorage.setItem('savedRoute', JSON.stringify(waypoints.map(w => w.latLng)));
                alert("Route saved!");
            }
        }

        function loadSavedRoute() {
            const saved = localStorage.getItem('savedRoute');
            if (saved) {
                const waypoints = JSON.parse(saved);
                userLatLng = waypoints[0];
                updateUserMarker();
                if (destinationMarker) map.removeLayer(destinationMarker);
                destinationMarker = L.marker(waypoints[1], {icon: destinationIcon}).addTo(map)
                    .bindPopup("Saved Destination").openPopup();
                calculateRoute(waypoints[1]);
            }
        }

        function clearAll() {
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);
            clearPOIs();
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('weatherInfo').style.display = 'none';
            searchInput.value = '';
            destinationMarker = null;
            routingControl = null;
        }

        function updateWeather() {
            const temp = (Math.random() * 20 + 10).toFixed(1);
            const condition = ['Sunny', 'Cloudy', 'Rainy'][Math.floor(Math.random() * 3)];
            document.getElementById('weatherCondition').textContent = condition;
            document.getElementById('weatherTemp').textContent = `${temp}Â°C`;
        }

        function haversineDistance(latLng1, latLng2) {
            const R = 6371;
            const dLat = (latLng2[0] - latLng1[0]) * Math.PI / 180;
            const dLon = (latLng2[1] - latLng1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(latLng1[0] * Math.PI / 180) * Math.cos(latLng2[0] * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Load saved route on start
        loadSavedRoute();
    </script>
</body>
</html>
